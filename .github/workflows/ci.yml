name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ── Job 1: Lint ──
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - run: pnpm --filter @hex-di/result lint
      - run: pnpm audit --audit-level=high

  # ── Job 2: Type Check (full TS matrix) ──
  type-check:
    name: Type Check (TS ${{ matrix.typescript }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        typescript: ["5.6", "5.7", "latest"]
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - if: matrix.typescript != 'latest'
        run: pnpm --filter @hex-di/result add -D typescript@${{ matrix.typescript }}
      - run: pnpm --filter @hex-di/result typecheck

  # ── Job 3: Unit Tests (full Node + OS matrix) ──
  unit-tests:
    name: Unit Tests (Node ${{ matrix.node }}, ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        node: [18, 20, 22]
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - run: pnpm --filter @hex-di/result test

  # ── Job 4: Type Tests (full TS matrix) ──
  type-tests:
    name: Type Tests (TS ${{ matrix.typescript }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        typescript: ["5.6", "5.7", "latest"]
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - if: matrix.typescript != 'latest'
        run: pnpm --filter @hex-di/result add -D typescript@${{ matrix.typescript }}
      - run: pnpm --filter @hex-di/result test:types

  # ── Job 5: Mutation Tests ──
  mutation-tests:
    name: Mutation Tests (Stryker)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - run: pnpm --filter @hex-di/result test:mutation

  # ── Job 6: GxP Integrity Tests (blocks PR) ──
  gxp-integrity:
    name: GxP Integrity Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - run: cd packages/result && npx vitest run tests/gxp/

  # ── Job 7: Cucumber Acceptance Tests (blocks PR) ──
  cucumber:
    name: Cucumber Acceptance Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - run: pnpm --filter @hex-di/result test:cucumber

  # ── Job 8: Traceability Verification (blocks PR) ──
  traceability:
    name: Traceability Verification
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: bash packages/result/scripts/verify-traceability.sh
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: traceability-report
          path: packages/result/traceability-report.txt
          retention-days: 90

  # ── Job 9: ATR-1 Compliance Check (blocks PR) ──
  atr1-compliance:
    name: ATR-1 Compliance Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check for andTee/orTee in GxP-annotated files
        run: |
          # ATR-1: andTee() and orTee() are prohibited in GxP-annotated files
          # per 21 CFR 11.10(e) — they suppress exceptions, which can silently
          # discard audit trail write failures.
          violations=0
          for pattern in 'andTee' 'orTee'; do
            if grep -rn "$pattern" packages/result/src/gxp/ packages/result/src/**/*.gxp.ts 2>/dev/null; then
              echo "::error::ATR-1 VIOLATION: $pattern found in GxP-annotated file"
              violations=$((violations + 1))
            fi
          done
          if [ "$violations" -gt 0 ]; then
            echo "::error::ATR-1 compliance check failed with $violations violation(s)"
            exit 1
          fi
          echo "ATR-1 compliance check passed"

  # ── Job 10: Build ──
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - run: pnpm --filter @hex-di/result build
      - name: Verify dist output
        run: test -d packages/result/dist

  # ── Job 11: Subpath Export Tests ──
  subpath-exports:
    name: Subpath Export Tests (Node ${{ matrix.node }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node: [18, 20, 22]
    needs: build
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - run: pnpm --filter @hex-di/result build
      - name: Verify ESM subpath imports resolve
        run: |
          cd packages/result
          node -e "import('@hex-di/result').then(() => console.log('main: OK'))"
          node -e "import('@hex-di/result/fn').then(() => console.log('fn: OK'))"
          node -e "import('@hex-di/result/async').then(() => console.log('async: OK'))"
          node -e "import('@hex-di/result/combinators').then(() => console.log('combinators: OK'))"
          node -e "import('@hex-di/result/errors').then(() => console.log('errors: OK'))"
          node -e "import('@hex-di/result/option').then(() => console.log('option: OK'))"
          node -e "import('@hex-di/result/unsafe').then(() => console.log('unsafe: OK'))"
      - name: Verify internal subpath is blocked (INV-13)
        run: |
          cd packages/result
          if node -e "import('@hex-di/result/internal/core/brand')" 2>/dev/null; then
            echo "::error::INV-13 VIOLATION: internal subpath resolved successfully"
            exit 1
          fi
          echo "INV-13: internal subpath correctly blocked"
