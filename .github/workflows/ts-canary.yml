name: TypeScript Nightly Canary

on:
  schedule:
    - cron: "0 0 * * *" # Daily at 00:00 UTC
  workflow_dispatch:

jobs:
  ts-nightly:
    name: TypeScript Nightly
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - run: pnpm --filter @hex-di/result add -D typescript@next
      - name: Type Check
        id: typecheck
        continue-on-error: true
        run: pnpm --filter @hex-di/result typecheck
      - name: Type Tests
        id: typetests
        continue-on-error: true
        run: pnpm --filter @hex-di/result test:types
      - name: Create issue on failure
        if: steps.typecheck.outcome == 'failure' || steps.typetests.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const title = `TypeScript nightly build failure (${new Date().toISOString().split('T')[0]})`;
            const body = [
              '## TypeScript Nightly Canary Failure',
              '',
              `**Date**: ${new Date().toISOString()}`,
              `**TypeScript version**: \`typescript@next\``,
              `**Type Check**: ${('${{ steps.typecheck.outcome }}' === 'failure') ? '❌ FAILED' : '✅ Passed'}`,
              `**Type Tests**: ${('${{ steps.typetests.outcome }}' === 'failure') ? '❌ FAILED' : '✅ Passed'}`,
              '',
              `**Run**: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              '',
              'This is an automated issue from the TypeScript nightly canary workflow.',
              'This does **not** block releases — it is informational only.',
            ].join('\n');

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
              labels: ['ts-canary'],
            });
